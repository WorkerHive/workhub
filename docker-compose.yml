version: "3.3"
services:
  queendb:
    image: "balbatross/queendb"
    volumes:
      - "${WORKHUB_FS}/queendb:/var/lib/postgresql/data"
    ports:
      - "127.0.0.1:5432:5432"
    environment:
      POSTGRES_PASSWORD: "defaultpassword"
  rabbit1:
    image: "rabbitmq:3-management"
    environment:
      RABBITMQ_ERLANG_COOKIE: "SWQOKODSQALRPCLNMEQG"
      RABBITMQ_DEFAULT_USER: "rabbitmq"
      RABBITMQ_DEFAULT_PASS: "rabbitmq"
      RABBITMQ_DEFAULT_VHOST: "/"
    volumes:
      - "${WORKHUB_FS}/rabbitmq:/var/lib/rabbitmq"
    ports:
      - "127.0.0.1:15672:15672"
      - "127.0.0.1:5672:5672"
    labels:
      NAME: "rabbitmq"
  load-balancer:
    image: nginx
    volumes:
      - "${WORKHUB_FS}/greenlock.d/live/${WORKHUB_DOMAIN}/cert.pem:/etc/nginx/cert.pem"
      - "${WORKHUB_FS}/greenlock.d/live/${WORKHUB_DOMAIN}/privkey.pem:/etc/nginx/privkey.pem"
      - "${WORKHUB_FS}/greenlock.d/live/${WORKHUB_DOMAIN}/fullchain.pem:/etc/nginx/fullchain.pem"
      - "${WORKHUB_FS}/web-ui:/data/web-ui/"
      - "./nginx-conf/nginx.conf:/etc/nginx/nginx.conf:ro"
    command: [nginx-debug, '-g', 'daemon off;']
    expose:
      - "80"
      - "443"
    ports: 
      - "80:80"
      - "443:443"
    depends_on:
      - graph
      - signal
  signal:
    image: libp2p/js-libp2p-webrtc-star
    environment:
      - VIRTUAL_PORT=6969
    expose:
      - "6969"
  yjs:
    build: "./y-websockets-server"
    volumes:
      - "${WORKHUB_FS}/yjs:/data/ydir"
    expose: 
      - "1234"
  graph:
    build:
      context: ./graph-layer
      dockerfile: "Dockerfile"
      args:
        - domain=$WORKHUB_DOMAIN
        - WEBUI_VERSION=$WEBUI_VERSION
    expose:
      - "4002"
    ports:
      - "1234:1234"
      - "4001:4001"
      - "4003:4003"
    volumes:
      - "${WORKHUB_FS}/workhub:/data/workhub"
      - "${WORKHUB_FS}:/data/cae"
      - "${WORKHUB_FS}/ipfs:/graph/workhub-graph/workhub"
      - "${WORKHUB_FS}/greenlock.d:/graph/workhub-graph/greenlock.d"
    environment:
      WORKHUB_DOMAIN: "${WORKHUB_DOMAIN}"
      QUEENDB_HOST: "queendb"
      QUEENDB_PASS: "defaultpassword"
      MQ_URL: 'amqp://rabbitmq:rabbitmq@rabbit1'
    depends_on:
      - signal
      - mongo
      - rabbit1
